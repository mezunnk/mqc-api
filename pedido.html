<!doctype html>
<html lang="pt-br">
<meta charset="utf-8">
<title>Pedido rápido - MaisQueCafe</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="stylesheet" href="custom.css">
<style>
    body {
        font-family: system-ui, Arial, sans-serif;
        max-width: 800px;
        margin: 24px auto;
        padding: 0 16px
    }
    
    .card {
        border: 1px solid #ddd;
        border-radius: 12px;
        padding: 16px;
        margin: 12px 0;
        box-shadow: 0 1px 4px rgba(0, 0, 0, .05)
    }
    
    label {
        display: block;
        margin-top: 8px;
        font-weight: 600
    }
    
    input,
    select,
    button,
    textarea {
        width: 100%;
        padding: 10px;
        border: 1px solid #ccc;
        border-radius: 10px;
        margin-top: 4px
    }
    
    .row {
        display: flex;
        gap: 12px
    }
    
    .row>* {
        flex: 1
    }
    
    table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 8px
    }
    
    th,
    td {
        border-bottom: 1px solid #eee;
        padding: 8px;
        text-align: left
    }
    
    .muted {
        color: #777
    }
</style>

<body>
    <h1>Pedido rápido</h1>
    <p class="muted">Este formulário envia direto para a API local (<code>http://127.0.0.1:8000</code>). Ajuste a chave abaixo.</p>

    <div class="card">
        <label>URL da API</label>
        <input id="api" value="http://127.0.0.1:8000">
        <label>Chave (x-api-key)</label>
        <input id="key" value="dev-123">
    </div>

    <div class="card">
        <div class="row">
            <div>
                <label>ID da Unidade</label>
                <input id="unidade_id" placeholder="ex.: 1">
            </div>
            <div>
                <label>ID do Fornecedor</label>
                <input id="fornecedor_id" placeholder="ex.: 1">
            </div>
        </div>
        <div class="row">
            <div>
                <label>Gerente</label>
                <input id="gerente" placeholder="Nome do gerente">
            </div>
            <div>
                <label>Contato</label>
                <input id="contato" placeholder="cel/email">
            </div>
        </div>
        <label>Desejado para (AAAA-MM-DD)</label>
        <input id="desejado" placeholder="2025-09-01">
        <label>Observações</label>
        <textarea id="obs" rows="2"></textarea>
    </div>

    <div class="card">
        <h3>Itens</h3>
        <table id="itens">
            <thead>
                <tr>
                    <th>Produto ID</th>
                    <th>Qtd</th>
                    <th>Preço (opcional)</th>
                    <th></th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
        <button onclick="addItem()">+ Adicionar item</button>
    </div>

    <div class="card">
        <button onclick="enviar()">Enviar pedido</button>
        <pre id="out" class="muted" style="white-space:pre-wrap;margin-top:12px"></pre>
    </div>

    <script>
        function addItem() {
            const tb = document.querySelector("#itens tbody");
            const tr = document.createElement("tr");
            tr.innerHTML = `
    <td><input placeholder="produto_id"></td>
    <td><input placeholder="qtd"></td>
    <td><input placeholder="preco (opcional)"></td>
    <td><button onclick="this.closest('tr').remove()">remover</button></td>
  `;
            tb.appendChild(tr);
        }

        async function enviar() {
            const base = document.getElementById("api").value.trim();
            const key = document.getElementById("key").value.trim();
            const unidade_id = parseInt(document.getElementById("unidade_id").value);
            const fornecedor_id = parseInt(document.getElementById("fornecedor_id").value);
            const gerente = document.getElementById("gerente").value.trim();
            const contato = document.getElementById("contato").value.trim();
            const desejado = document.getElementById("desejado").value.trim() || null;
            const obs = document.getElementById("obs").value.trim() || null;

            const itens = [...document.querySelectorAll("#itens tbody tr")].map(tr => {
                const tds = tr.querySelectorAll("td input");
                const pid = parseInt(tds[0].value);
                const qtd = parseFloat(tds[1].value);
                const preco = tds[2].value.trim();
                return {
                    produto_id: pid,
                    quantidade: qtd,
                    preco: preco === '' ? null : parseFloat(preco)
                };
            }).filter(i => !isNaN(i.produto_id) && !isNaN(i.quantidade));

            const body = {
                unidade_id,
                fornecedor_id,
                gerente_nome: gerente,
                contato,
                desejado_para: desejado,
                observacoes: obs,
                itens
            };

            try {
                const r = await fetch(`${base}/pedidos`, {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                        "x-api-key": key
                    },
                    body: JSON.stringify(body)
                });
                const data = await r.json();
                if (!r.ok) throw data;
                document.getElementById("out").textContent = JSON.stringify(data, null, 2) + "\n\nAgora clique para ENVIAR:";
                // mostra botão enviar
                const btn = document.createElement("button");
                btn.textContent = "Enviar para aprovação/autorizar";
                btn.onclick = async() => {
                    const r2 = await fetch(`${base}/pedidos/${data.id}/enviar`, {
                        method: "POST",
                        headers: {
                            "x-api-key": key
                        }
                    });
                    const d2 = await r2.json();
                    document.getElementById("out").textContent = JSON.stringify(d2, null, 2);
                };
                document.getElementById("out").appendChild(btn);
            } catch (e) {
                document.getElementById("out").textContent = "Erro:\n" + JSON.stringify(e, null, 2);
            }
        }

        // adiciona uma linha inicial
        addItem();
    </script>
</body>

</html>